#!/bin/bash
#
# mcp-with-vault - Wrapper to start Docker MCP Gateway with OCI Vault secrets resolution
#
# This script:
# 1. Reads the current MCP config
# 2. Resolves oci-vault:// references using OCI Vault
# 3. Applies the resolved config to the gateway
# 4. Starts the gateway (optional)
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RESOLVER="$SCRIPT_DIR/oci_vault_resolver.py"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
CACHE_TTL=3600  # 1 hour
VERBOSE=false
DRY_RUN=false
START_GATEWAY=false
INSTANCE_PRINCIPALS=false

usage() {
    cat << EOF
Usage: $0 [OPTIONS]

Resolve OCI Vault secrets in Docker MCP Gateway configuration and optionally start the gateway.

OPTIONS:
    --ttl SECONDS          Cache TTL in seconds (default: 3600)
    --verbose              Enable verbose logging
    --dry-run              Show resolved config without applying
    --start                Start the gateway after applying config
    --instance-principals  Use instance principals (for OCI VMs)
    --help                 Show this help message

EXAMPLES:
    # Basic usage with parallel resolution
    $0

    # With instance principals (for OCI VMs)
    $0 --instance-principals

    # Dry run to see what would be resolved
    $0 --dry-run

    # Resolve with custom cache TTL and start gateway
    $0 --ttl 7200 --start

    # Verbose mode for debugging
    $0 --verbose

VAULT URL FORMATS:
    oci-vault://secret-ocid
    oci-vault://compartment-ocid/secret-name
    oci-vault://vault-ocid/secret-name

EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --ttl)
            CACHE_TTL="$2"
            shift 2
            ;;
        --verbose)
            VERBOSE=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --start)
            START_GATEWAY=true
            shift
            ;;
        --instance-principals)
            INSTANCE_PRINCIPALS=true
            shift
            ;;
        --help)
            usage
            exit 0
            ;;
        *)
            echo -e "${RED}ERROR: Unknown option: $1${NC}" >&2
            usage
            exit 1
            ;;
    esac
done

# Check dependencies
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}ERROR: python3 is required but not found${NC}" >&2
    exit 1
fi

if ! command -v oci &> /dev/null; then
    echo -e "${RED}ERROR: oci CLI is required but not found${NC}" >&2
    exit 1
fi

if ! command -v docker &> /dev/null; then
    echo -e "${RED}ERROR: docker CLI is required but not found${NC}" >&2
    exit 1
fi

if [[ ! -f "$RESOLVER" ]]; then
    echo -e "${RED}ERROR: Resolver script not found: $RESOLVER${NC}" >&2
    exit 1
fi

# Check if PyYAML is installed
if ! python3 -c "import yaml" 2>/dev/null; then
    echo -e "${YELLOW}WARNING: PyYAML not found. Installing...${NC}" >&2
    pip3 install --user PyYAML || {
        echo -e "${RED}ERROR: Failed to install PyYAML${NC}" >&2
        exit 1
    }
fi

echo -e "${BLUE}==> Reading current MCP configuration${NC}"

# Read current config
ORIGINAL_CONFIG=$(docker mcp config read 2>&1) || {
    echo -e "${RED}ERROR: Failed to read MCP config${NC}" >&2
    exit 1
}

# Build resolver command
RESOLVER_CMD="python3 $RESOLVER --ttl $CACHE_TTL"
if [[ "$VERBOSE" == "true" ]]; then
    RESOLVER_CMD="$RESOLVER_CMD --verbose"
fi
if [[ "$INSTANCE_PRINCIPALS" == "true" ]]; then
    RESOLVER_CMD="$RESOLVER_CMD --instance-principals"
fi
echo -e "${BLUE}==> Resolving OCI Vault secrets (parallel mode)${NC}"

# Resolve secrets
RESOLVED_CONFIG=$(echo "$ORIGINAL_CONFIG" | $RESOLVER_CMD) || {
    echo -e "${RED}ERROR: Failed to resolve secrets${NC}" >&2
    exit 1
}

if [[ "$DRY_RUN" == "true" ]]; then
    echo -e "${YELLOW}==> Dry run - resolved configuration:${NC}"
    echo "$RESOLVED_CONFIG"
    exit 0
fi

# Apply resolved config
echo -e "${BLUE}==> Applying resolved configuration to gateway${NC}"

echo "$RESOLVED_CONFIG" | docker mcp config write || {
    echo -e "${RED}ERROR: Failed to apply config${NC}" >&2
    exit 1
}

echo -e "${GREEN}✓ Configuration successfully applied${NC}"

# Optionally start gateway
if [[ "$START_GATEWAY" == "true" ]]; then
    echo -e "${BLUE}==> Starting MCP Gateway${NC}"
    docker mcp gateway start || {
        echo -e "${RED}ERROR: Failed to start gateway${NC}" >&2
        exit 1
    }
    echo -e "${GREEN}✓ Gateway started${NC}"
fi

echo -e "${GREEN}==> Done!${NC}"
