# Pre-commit hooks for OCI Vault MCP Resolver
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files

repos:
  # Code Formatting
  - repo: https://github.com/psf/black
    rev: 24.1.1
    hooks:
      - id: black
        name: Format code with Black
        args: [--line-length=100]
        language_version: python3

  # Linting & Style
  - repo: https://github.com/PyCQA/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        name: Lint with flake8
        args:
          - --max-line-length=100
          - --ignore=E203,W503  # Black compatibility
          - --max-complexity=10
        additional_dependencies: [flake8-docstrings]
        exclude: ^tests/

  # Type Checking
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy
        name: Type check with mypy
        args: [--strict, --ignore-missing-imports]
        additional_dependencies:
          - types-PyYAML>=6.0.12
          - oci>=2.126.0
        exclude: ^tests/

  # Security Scanning
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.7
    hooks:
      - id: bandit
        name: Security scan with bandit
        args:
          - -ll  # Only show high severity
          - --skip=B404,B603  # Allow subprocess (needed for OCI CLI)
          - -r
          - .
        exclude: ^tests/

  # General Checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: Remove trailing whitespace

      - id: end-of-file-fixer
        name: Ensure files end with newline

      - id: check-yaml
        name: Validate YAML files

      - id: check-json
        name: Validate JSON files

      - id: check-added-large-files
        name: Check for large files
        args: [--maxkb=500]

      - id: check-merge-conflict
        name: Check for merge conflict markers

      - id: check-case-conflict
        name: Check for case conflicts in filenames

      - id: mixed-line-ending
        name: Detect mixed line endings
        args: [--fix=lf]

      - id: detect-private-key
        name: Detect private keys
        exclude: ^tests/

  # Python-specific Checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: check-ast
        name: Validate Python AST

      - id: debug-statements
        name: Check for debugger imports

      - id: name-tests-test
        name: Ensure test files match test_*.py
        args: [--pytest-test-first]
        files: ^tests/
        exclude: 'tests/(README\.md|INTEGRATION_TESTING\.md|__init__\.py|conftest\.py)'

  # Import Sorting
  - repo: https://github.com/PyCQA/isort
    rev: 5.13.2
    hooks:
      - id: isort
        name: Sort imports with isort
        args:
          - --profile=black
          - --line-length=100

  # Custom Local Hooks
  - repo: local
    hooks:
      - id: pytest-check
        name: Run pytest with coverage
        entry: pytest
        language: system
        pass_filenames: false
        always_run: true
        args:
          - tests/
          - --cov=oci_vault_resolver
          - --cov-fail-under=80
          - --tb=short
          - -q

      - id: complexity-check
        name: Check cyclomatic complexity
        entry: bash
        language: system
        pass_filenames: false
        always_run: true
        args:
          - -c
          - |
            if command -v radon &> /dev/null; then
              echo "Checking cyclomatic complexity..."
              radon cc oci_vault_resolver.py -a --total-average
              MAX_CC=$(radon cc oci_vault_resolver.py -j | python3 -c "import sys, json; print(max((f.get('complexity', 0) for file_funcs in json.load(sys.stdin).values() for f in file_funcs), default=0))")
              if [ "$MAX_CC" -gt 10 ]; then
                echo "❌ Complexity gate failed: Max complexity $MAX_CC > 10"
                exit 1
              fi
              echo "✅ Complexity check passed (max: $MAX_CC)"
            else
              echo "⚠️  radon not installed, skipping complexity check"
              echo "   Install with: pip install radon"
            fi

# Configuration
default_language_version:
  python: python3

# Exclude patterns
exclude: |
  (?x)^(
      \.git/|
      \.mypy_cache/|
      \.pytest_cache/|
      \.venv/|
      venv/|
      __pycache__/|
      build/|
      dist/|
      \.eggs/|
      htmlcov/|
      \.coverage|
      coverage\.xml
  )
